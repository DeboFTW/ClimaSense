<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Weather App</title>
  <link rel="icon" href="../static/weather.png">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/chatbot.css">

  <script src="https://kit.fontawesome.com/9df87047e7.js" crossorigin="anonymous"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">

</head>

<body>

  <section id="sec-1" class="background-tint">

    <div class="container">

    </div>

    <div class="sec-1-content">
      {% if predict_status: %}
      <h1 class="main-heading"> Your Data is Predicted Using Our Machine Learning Model </h1>
      {% else: %}
      <h1 class="main-heading"> ClimaSense: A Smart Weather and Air Quality Monitoring Dashboard</h1>
      {% endif %}
    </div>
  </section>

  <section id="sec-2">

    <div class="row container-fluid">

      <div class="row justify-content-center text-center">
        <div class="feature-box col-lg-4">
        <a href="#sec-3" class="item"><h3 class="feature-heading">Current Weather</h3></a>
        <p>Check weather in your city</p>
      </div>

      <div class="feature-box col-lg-4">
        <a href="#sec-4" class="item"><h3 class="feature-heading">Weather Prediction</h3></a>
        <p>Predict weather for the next 5 hours in your city</p>
        <a class="btn btn-primary btn-outline-light get-started" href="#sec-4">Go</a>
      </div>
  
      <div class="feature-box col-lg-4">
        <a href="#sec-3-5" class="item"><h3 class="feature-heading">Air Quality Index</h3></a>
        <p>Get AQI and predictions for the next 5 hours</p>
        <a class="btn btn-primary btn-outline-light get-started" href="#sec-3-5">Go</a>
      </div>

    </div>

  </section>

  <section id="sec-3" class="background-tint-1">

    <section class="vh-100">
      <div class="container py-4 h-100">      
        <div class="row d-flex justify-content-center align-items-center">
          <h1 class="mb-4 sec-3-heading">Check the weather forecast </h1>
          <div class="col-md-8 col-lg-6 col-xl-4">

            <form name="city search" id="weatherSearch" action="{{ url_for('home') }}" method="post" novalidate>
              <div class="input-group rounded mb-3">
                <input type="search" name="city" class="form-control rounded" placeholder="Enter City Name" aria-label="Search" aria-describedby="search-addon" />
                <span>
                  <button type="submit" class="btn btn-primary" id="searchCity">Check</button>
                </span>
              </div>
            </form>
    
            <div class="card shadow-0 border">
              <div class="card-body p-4">
                {% if status: %}
                <h4 class="mb-3 sfw-normal ">{{ city }}, {{ country }}</h4>
                <p class="mb-2">Current temperature: <strong>{{ current_temp }}°C</strong></p>
                <p>Feels like: <strong>{{ feels_like }}°C</strong></p>
                <p>Max: <strong>{{ temp_max }}°C</strong>, Min: <strong>{{ temp_min }}°C</strong></p>
                <p>Humidity: <strong>{{ humidity }} %</strong></p>
    
                <div class="d-flex flex-row align-items-center">
                  <p class="mb-0 me-4">{{ description }}</p>
                  {% else: %}
                  <h4 class="mb-3 sfw-normal">Your City</h4>
                  <p class="mb-2">Current temperature: -<strong>-</strong></p>
                  <p>Feels like: -<strong>-</strong></p>
                  <p>Max: <strong>-</strong>  Min: <strong>-</strong></p>
                  <p>Humidity: -</p>
    
                  <div class="d-flex flex-row align-items-center">
                    <p class="mb-0 me-4">Status Unknown</p>
                    {% endif %}
                    <i class="fas fa-cloud fa-3x" style="color: #eee;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    
      </div>
    </section>

  </section>

  <section id="sec-4">
    <h1 class="sec-4-heading"><strong>Weather Prediction</strong></h1>
    <h4 class="predict-text">Enter your city below to predict the weather of your location for next 5 hours</h4>
    <form name="city search" id="weatherSearch" action="{{ url_for('prediction') }}" method="post" novalidate>
      <div class="predict-city input-group rounded mb-3">
        <input type="search" name="city" class="form-control rounded" placeholder="Enter City Name" aria-label="Search" aria-describedby="search-addon" />
        <span>
          <button type="submit" class="btn btn-primary" id="searchCity">Predict</button>
        </span>
      </div>
    </form>
    {% if predict_status: %}
    <div class="container-table100">
      <div class="wrap-table100">
        <div class="table100">
          <table>
            <thead>
              <tr class="table100-head">
                <th class="column1">Time</th>
                <th class="column2">Temperature</th>
                <th class="column3">Humidity</th>
              </tr>
            </thead>

            <tbody class="table-body">
              <tr>
                <td class="column1">After 1 hour</td>
                <td class="column2">{{ temperature_1 }} °C</td>
                <td class="column3">{{ humidity_1 }} %</td>
              </tr>
              <tr>
                <td class="column1">After 2 hours</td>
                <td class="column2">{{ temperature_2 }}  °C</td>
                <td class="column3">{{ humidity_2 }} %</td>
              </tr>
              <tr>
                <td class="column1">After 3 hours</td>
                <td class="column2">{{ temperature_3 }}  °C</td>
                <td class="column3">{{ humidity_3 }} %</td>
              </tr>
              <tr>
                <td class="column1">After 4 hours</td>
                <td class="column2">{{ temperature_4 }}  °C</td>
                <td class="column3">{{ humidity_4 }} %</td>
              </tr>
              <tr>
                <td class="column1">After 5 hours</td>
                <td class="column2">{{ temperature_5 }}  °C</td>
                <td class="column3">{{ humidity_5 }} %</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div>
      <h3 class="sec-4-content"><strong>Predicted Graphs</strong></h3>
      <div class="graphs">
        <canvas id="tlineChart" width="700" height="400"></canvas>
        <script>
          var ctx = document.getElementById("tlineChart").getContext("2d");
          var tlineChart = new Chart (ctx, {
            type: "line",
            data: {
              labels: {{ tlabels | safe }},
              datasets: [
                {
                  label: "TEMPERATURE",
                  data: {{ tvalues | safe }},
                  fill: false,
                  borderColor: "rgb(75, 192, 192)",
                  backgroundColor: "rgb(75, 192, 192)",
                  lineTension: 0.1
                }
              ]
            },
            options: {
              responsive: false
            }
          });
        </script>

        <canvas id="hlineChart" width="700" height="400"></canvas>
        <script>
          var ctx = document.getElementById("hlineChart").getContext("2d");
          var hlineChart = new Chart (ctx, {
            type: "line",
            data: {
              labels: {{ hlabels | safe }},
              datasets: [
                {
                  label: "HUMIDITY",
                  data: {{ hvalues | safe }},
                  fill: false,
                  borderColor: "rgb(75, 192, 192)",
                  backgroundColor: "rgb(75, 192, 192)",
                  lineTension: 0.1
                }
              ]
            },
            options: {
              responsive: false,
            }
          });
        </script>
      </div>
    </div>
    
    {% if humidity_1 >= 75: %}
    <h4 class="sec-4-bottom">According to predicted data, it may rain in the next hour.</h4>
    {% elif humidity_2 >=75: %}
    <h4 class="sec-4-bottom">According to predicted data, it may rain in the next 2 hours.</h4>
    {% elif humidity_3  >= 75: %}
    <h4 class="sec-4-bottom">According to predicted data, it may rain in the next 3 hours.</h4>
    {% elif humidity_4  >= 75: %}
    <h4 class="sec-4-bottom">According to predicted data, it may rain in the next 4 hours.</h4>
    {% elif humidity_5  >= 75: %}
    <h4 class="sec-4-bottom">According to predicted data, it may rain in the next 5 hours.</h4>
    {% else: %}
    <h4 class="sec-4-bottom">According to predicted data, it may not rain in the next 5 hours.</h4>
    {% endif %}
    {% else: %}
    <h1></h1>
    {% endif %}

  </section>

</body>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('aq-search-form');
  const cityInput = document.getElementById('aq-city-input');
  const loadingEl = document.getElementById('aq-loading');
  const errorEl = document.getElementById('aq-error');
  const resultsEl = document.getElementById('aq-results');
  
  // Check if elements exist
  if (!form || !cityInput) {
    console.error('AQ form elements not found');
    return;
  }
  
  function getAQICategory(pm25) {
    if (pm25 <= 12) return { label: 'Good', class: 'text-success' };
    if (pm25 <= 35.4) return { label: 'Moderate', class: 'text-warning' };
    if (pm25 <= 55.4) return { label: 'Unhealthy for Sensitive', class: 'text-danger' };
    if (pm25 <= 150.4) return { label: 'Unhealthy', class: 'text-danger' };
    if (pm25 <= 250.4) return { label: 'Very Unhealthy', class: 'text-danger' };
    return { label: 'Hazardous', class: 'text-danger' };
  }
  
  form.addEventListener('submit', function(e){
    e.preventDefault();
    e.stopPropagation();
    
    const city = cityInput.value.trim();
    if (!city) return false;
    
    // Show loading, hide others
    loadingEl.classList.remove('d-none');
    errorEl.classList.add('d-none');
    resultsEl.classList.add('d-none');
    
    // Fetch air quality data
    fetch('/api/air-quality/' + encodeURIComponent(city))
      .then(function(resp){
        if (!resp.ok) {
          return resp.json().then(function(data){
            throw new Error(data.error || 'Failed to fetch data');
          });
        }
        return resp.json();
      })
      .then(function(response){
        loadingEl.classList.add('d-none');
        
        if (!response.success) {
          throw new Error(response.error || 'Unknown error');
        }
        
        const data = response.data;
        const current = data.current;
        
        // Update city name and time
        document.getElementById('aq-city-name').textContent = response.city;
        
        if (current && current.time) {
          const timeStr = new Date(current.time).toLocaleString();
          document.getElementById('aq-time').textContent = timeStr;
        }
        
        // Update current PM2.5 and category
        if (current) {
          document.getElementById('aq-current-pm25').textContent = current.pm25.toFixed(1);
          
          const category = getAQICategory(current.pm25);
          const categoryEl = document.getElementById('aq-current-category');
          categoryEl.textContent = current.category;
          categoryEl.className = 'badge ' + category.class.replace('text-', 'bg-');
        }
        
        // Update plot image with timestamp to avoid cache
        const plotImg = document.getElementById('aq-plot-img');
        plotImg.src = response.plot_url + '?ts=' + Date.now();
        
        // Show results
        resultsEl.classList.remove('d-none');
      })
      .catch(function(err){
        loadingEl.classList.add('d-none');
        errorEl.textContent = 'Error: ' + err.message;
        errorEl.classList.remove('d-none');
      });
    
    return false;
  });
});
</script>

<!-- Chatbot Widget -->
<div class="chatbot-container">
  <!-- Toggle Button -->
  <button class="chatbot-toggle" id="chatbotToggle">
    <i class="fas fa-comments"></i>
    <span class="notification-badge" id="notificationBadge">1</span>
  </button>

  <!-- Chat Window -->
  <div class="chatbot-window" id="chatbotWindow">
    <!-- Header -->
    <div class="chatbot-header">
      <div class="d-flex align-items-center">
        <div class="chatbot-avatar">
          <i class="fas fa-cloud-sun"></i>
        </div>
        <div>
          <h6 class="mb-0">ClimaSense Assistant</h6>
          <small class="text-white-50">Always here to help</small>
        </div>
      </div>
      <button class="chatbot-close" id="chatbotClose">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Messages Area -->
    <div class="chatbot-messages" id="chatbotMessages">
      <!-- Welcome Message -->
      <div class="message bot">
        <div class="message-content">
          <p>Hi! 👋 I'm ClimaSense Assistant.<br><br>Ask me:<br>• "What's the weather in Kolkata?"<br>• "Predict weather for Mumbai"<br>• "Temperature in London"</p>
        </div>
      </div>
    </div>

    <!-- Quick Replies -->
    <div class="quick-replies" id="quickReplies">
      <button class="quick-reply-btn" data-message="How to use?">How to use?</button>
      <button class="quick-reply-btn" data-message="Weather in Mumbai">Weather in Mumbai</button>
      <button class="quick-reply-btn" data-message="Predict weather">Predict weather</button>
    </div>

    <!-- Input Area -->
    <div class="chatbot-input-area">
      <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Type your message...">
      <button class="chatbot-send" id="chatbotSend">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<!-- Chatbot JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const chatbotToggle = document.getElementById('chatbotToggle');
  const chatbotClose = document.getElementById('chatbotClose');
  const chatbotWindow = document.getElementById('chatbotWindow');
  const chatbotMessages = document.getElementById('chatbotMessages');
  const chatbotInput = document.getElementById('chatbotInput');
  const chatbotSend = document.getElementById('chatbotSend');
  const quickReplies = document.getElementById('quickReplies');
  const notificationBadge = document.getElementById('notificationBadge');

  let isOpen = false;

  // Toggle chat window
  chatbotToggle.addEventListener('click', function() {
    isOpen = !isOpen;
    chatbotWindow.style.display = isOpen ? 'flex' : 'none';
    notificationBadge.style.display = 'none';
    
    if (isOpen) {
      chatbotInput.focus();
    }
  });

  // Close chat window
  chatbotClose.addEventListener('click', function() {
    isOpen = false;
    chatbotWindow.style.display = 'none';
  });

  // Send message function
  function sendMessage(message) {
    if (!message.trim()) return;

    // Add user message to chat
    addMessage(message, 'user');
    chatbotInput.value = '';

    // Show typing indicator
    showTypingIndicator();

    // Send to backend
    fetch('/chatbot', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
      // Remove typing indicator
      removeTypingIndicator();

      if (data.success) {
        // Add bot response
        addMessage(data.response, 'bot');

        // Update quick replies
        if (data.quick_replies && data.quick_replies.length > 0) {
          updateQuickReplies(data.quick_replies);
        }
      } else {
        addMessage("Sorry, I'm having trouble right now. Please try again!", 'bot');
      }
    })
    .catch(error => {
      removeTypingIndicator();
      addMessage("Oops! Something went wrong. Please check your connection.", 'bot');
      console.error('Chatbot error:', error);
    });
  }

  // Add message to chat
  function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    const textP = document.createElement('p');
    textP.innerHTML = text.replace(/\n/g, '<br>');
    
    contentDiv.appendChild(textP);
    messageDiv.appendChild(contentDiv);
    chatbotMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
  }

  // Show typing indicator
  function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot typing-message';
    typingDiv.id = 'typingIndicator';
    
    const indicatorDiv = document.createElement('div');
    indicatorDiv.className = 'typing-indicator';
    indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
    
    typingDiv.appendChild(indicatorDiv);
    chatbotMessages.appendChild(typingDiv);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
  }

  // Remove typing indicator
  function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
      typingIndicator.remove();
    }
  }

  // Update quick replies
  function updateQuickReplies(replies) {
    quickReplies.innerHTML = '';
    replies.forEach(reply => {
      const button = document.createElement('button');
      button.className = 'quick-reply-btn';
      button.textContent = reply;
      button.setAttribute('data-message', reply);
      button.addEventListener('click', function() {
        sendMessage(this.getAttribute('data-message'));
      });
      quickReplies.appendChild(button);
    });
  }

  // Send button click
  chatbotSend.addEventListener('click', function() {
    sendMessage(chatbotInput.value);
  });

  // Enter key to send
  chatbotInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage(chatbotInput.value);
    }
  });

  // Quick reply buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('quick-reply-btn')) {
      sendMessage(e.target.getAttribute('data-message'));
    }
  });

  // Show notification after 3 seconds (first visit)
  setTimeout(function() {
    if (!isOpen && !sessionStorage.getItem('chatbotSeen')) {
      notificationBadge.style.display = 'flex';
      sessionStorage.setItem('chatbotSeen', 'true');
    }
  }, 3000);
});
</script>

</html>
